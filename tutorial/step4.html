<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from xdocs/tutorial\step4.xml at 14 Sep 2021

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <meta name="author" content="Siegfried Goeschl" />
    <title>Fulcrum YAAFI Avalon Container &#x2013; Fulcrum YAAFI Avalon Container Tutorial Step 4</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://turbine.apache.org/" id="bannerLeft" title="Apache Turbine"><img src="https://turbine.apache.org/images/turbine-project.png"  alt="Apache Turbine"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 14 Sep 2021</span>
          &#xA0;| <span id="projectVersion">Version: 1.0.9-SNAPSHOT</span>
      </div>
      <div class="xright"><a href="https://www.apache.org" class="externalLink" title="Apache">Apache</a> |
<a href="https://turbine.apache.org/" class="externalLink" title="Turbine">Turbine</a> |
<a href="https://turbine.apache.org/fulcrum/" class="externalLink" title="Fulcrum">Fulcrum</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Overview</h5>
    <ul>
     <li class="none"><a href="../index.html" title="Main">Main</a></li>
     <li class="none"><a href="../downloads.html" title="Downloads">Downloads</a></li>
     <li class="none"><a href="../howto.html" title="How To">How To</a></li>
     <li class="none"><a href="../cryptography.html" title="Cryptography">Cryptography</a></li>
     <li class="collapsed"><a href="../lifecycle/index.html" title="Lifecycle">Lifecycle</a></li>
     <li class="collapsed"><a href="../interceptors/index.html" title="Interceptors">Interceptors</a></li>
     <li class="collapsed"><a href="../services/index.html" title="Services">Services</a></li>
     <li class="collapsed"><a href="../specification/index.html" title="Specification">Specification</a></li>
     <li class="expanded"><a href="../tutorial/index.html" title="Tutorial">Tutorial</a>
      <ul>
       <li class="none"><a href="../tutorial/step1.html" title="Step 1">Step 1</a></li>
       <li class="none"><a href="../tutorial/step2.html" title="Step 2">Step 2</a></li>
       <li class="none"><a href="../tutorial/step3.html" title="Step 3">Step 3</a></li>
       <li class="none"><strong>Step 4</strong></li>
       <li class="none"><a href="../tutorial/step5.html" title="Step 5">Step 5</a></li>
      </ul></li>
     <li class="none"><a href="../design.html" title="Design Considerations">Design Considerations</a></li>
     <li class="none"><a href="../todo.html" title="Todo's">Todo's</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="../project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
       <h5>Apache</h5>
    <ul>
     <li class="none"><a href="https://www.apache.org/" class="externalLink" title="Apache Website">Apache Website</a></li>
     <li class="none"><a href="https://www.apache.org/licenses/" class="externalLink" title="License">License</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works">How the ASF works</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a></li>
     <li class="none"><a href="https://www.apache.org/security/" class="externalLink" title="Security">Security</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">


  

    <section>
<h2><a name="Running_an_Avalon_Service"></a>Running an Avalon Service</h2>

      
<p>
        Writing an Avalon service without running it is a rather
        academic approach. The YAAFI container was born out of the need
        to add infrastructure service to an existing web application.
        Therefore there are many ways to skin the YAAFI cat
        </p>
<ul>
          
<li>Using the org.apache.fulcrum.yaafi.framework.factory.ServiceContainerFactory</li>
          
<li>Using the org.apache.fulcrum.yaafi.cli.Main</li>
          
<li>Using another Avalon container</li>
        </ul>
      

      <section>
<h3><a name="Using_ServiceContainerFactory"></a>Using ServiceContainerFactory</h3>
        
<p>
          The easist way of getting it going is to define a container configuration
          file as shown below. The file contains the location of the Avalon artifacts
          to get the container and the services up and running.
          </p>
<div class="source">
<pre>

&lt;fulcrum-yaafi&gt;
  &lt;componentRoles&gt;
    &lt;location&gt;./tutorial/conf/componentRoles.xml&lt;/location&gt;
  &lt;/componentRoles&gt;
  &lt;componentConfiguration&gt;
    &lt;location&gt;./tutorial/conf/componentConfig.xml&lt;/location&gt;
  &lt;/componentConfiguration&gt;
  &lt;parameters&gt;
    &lt;location&gt;./tutorial/conf/parameters.properties&lt;/location&gt;
  &lt;/parameters&gt;
&lt;/fulcrum-yaafi&gt;
          </pre></div>
        
        
<p>
          After writing the container configuration file you fire up
          the factory to get an instance of the YAAFI container. Since
          all of the optional configuration the YAAFI container uses
          the default temp directory and a ConsoleLogger.
          </p>
<div class="source">
<pre>
ServiceContainer container = null;
ServiceContainerConfiguration config = null;

config = new ServiceContainerConfiguration();
config.loadContainerConfiguration( &quot;./tutorial/conf/containerConfiguration.xml&quot; );
container = ServiceContainerFactory.create( config );
          </pre></div>
        
        
<p>
          It is gooooooood practice to shutdown an Avalon container properly
          to give the running Avalon service a chance to free any
          resources
          </p>
<div class="source">
<pre>
container.dispose();
          </pre></div>
        
      </section>

      <section>
<h3><a name="Using_Main"></a>Using Main</h3>
        
<p>
          This class helps to run a command line application based on the YAAFI
          container. The following sample shows a more complex setup
          </p>
<ul>
            
<li>uses a ConsoleLogger</li>
            
<li>sets &quot;./temp&quot; as the temporary directory to be used</li>
            
<li>loads a container configuration file from &quot;./conf/containerConfiguration.xml</li>
            
<li>blocks the main thread until termination</li>
            
<li>installs a JVM shutdown hook to dispose the YAAFI container during JVM shutdown</li>
          </ul>
          
<div class="source">
<pre>
public class Application implements Runnable
{
    /** the YAAFI command line interface */
    private Main cli;

    public static void main( String[] args )
    {
        try
        {
            new Application(args).init().run();
        }
        catch( Throwable t )
        {
            String msg = &quot;Execution of the server failed : &quot; + t.getMessage();
            System.err.println(msg);
        }
    }

    public Application(String[] args)
    {
        this.cli = new Main(args);
    }

    protected Application init() throws Exception
    {
        // 1) initialize the YAAFI Main class

        // 1.1) set the temp directory to be used
        this.cli.setTempHome( &quot;./tutorial/temp&quot; );

        // 1.2) set the container configuration to bootstrap the YAAFI container
        this.cli.setContainerConfigValue( &quot;./tutorial/conf/containerConfiguration.xml&quot; );

        // 1.3) block the main thread until the JVM is terminated
        this.cli.setIsBlocking(true);

        // 1.4) install a JVM shutdown hook to dispose the YAAFI container
        this.cli.setHasShutdownHook(true);

        // 2) initialize the logger

        ConsoleLogger consoleLogger = new ConsoleLogger(ConsoleLogger.LEVEL_DEBUG);
        this.cli.setLogger( consoleLogger );

        return this;
    }

    public void run()
    {
        try
        {
            this.cli.initialize();
            this.cli.getLogger().info( &quot;The application is up and running ...&quot; );
            this.cli.onWait();
        }
        catch (Throwable t)
        {
            String msg = &quot;Running the server failed due to : &quot; + t.getMessage();
            this.cli.getLogger().error(msg,t);
            throw new RuntimeException(msg);
        }
    }
 }
          </pre></div>
        
      </section>

      <section>
<h3><a name="Using_Another_Avalon_Container"></a>Using Another Avalon Container</h3>
        
<p>
          Emebdding YAAFI into another Avalon container might sound like
          a no-brainer but YAAFI was successfully integrated as Avalon
          service in the JAMES mail server using the Phoenix container.
          The ugly truth behind it is the fact that Avalon services might
          not be portable across different Avalon service containers which
          definitely is a no-brainer.
        </p>
          
<div class="source">
<pre>
&lt;block name=&quot;fulcrum-yaafi&quot; class=&quot;org.apache.fulcrum.yaafi.framework.container.ServiceContainerImpl&quot; /&gt;

&lt;fulcrum-yaafi&gt;
  &lt;containerFlavour&gt;phoenix&lt;/containerFlavour&gt;
  &lt;componentRoles&gt;
    &lt;location&gt;../conf/componentRoles.xml&lt;/location&gt;
  &lt;/componentRoles&gt;
  &lt;componentConfiguration&gt;
    &lt;location&gt;../conf/componentConfiguration.xml&lt;/location&gt;
  &lt;/componentConfiguration&gt;
&lt;/fulcrum-yaafi&gt;
          </pre></div>

      </section>

    </section>

  


      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2004&#x2013;2021<a href="https://www.apache.org/">The Apache Software Foundation</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
