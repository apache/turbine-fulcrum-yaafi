<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from xdocs/tutorial\step3.xml at 14 Sep 2021

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <meta name="author" content="Siegfried Goeschl" />
    <title>Fulcrum YAAFI Avalon Container &#x2013; Fulcrum YAAFI Avalon Container Tutorial Step 3</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://turbine.apache.org/" id="bannerLeft" title="Apache Turbine"><img src="https://turbine.apache.org/images/turbine-project.png"  alt="Apache Turbine"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 14 Sep 2021</span>
          &#xA0;| <span id="projectVersion">Version: 1.0.9-SNAPSHOT</span>
      </div>
      <div class="xright"><a href="https://www.apache.org" class="externalLink" title="Apache">Apache</a> |
<a href="https://turbine.apache.org/" class="externalLink" title="Turbine">Turbine</a> |
<a href="https://turbine.apache.org/fulcrum/" class="externalLink" title="Fulcrum">Fulcrum</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Overview</h5>
    <ul>
     <li class="none"><a href="../index.html" title="Main">Main</a></li>
     <li class="none"><a href="../downloads.html" title="Downloads">Downloads</a></li>
     <li class="none"><a href="../howto.html" title="How To">How To</a></li>
     <li class="none"><a href="../cryptography.html" title="Cryptography">Cryptography</a></li>
     <li class="collapsed"><a href="../lifecycle/index.html" title="Lifecycle">Lifecycle</a></li>
     <li class="collapsed"><a href="../interceptors/index.html" title="Interceptors">Interceptors</a></li>
     <li class="collapsed"><a href="../services/index.html" title="Services">Services</a></li>
     <li class="collapsed"><a href="../specification/index.html" title="Specification">Specification</a></li>
     <li class="expanded"><a href="../tutorial/index.html" title="Tutorial">Tutorial</a>
      <ul>
       <li class="none"><a href="../tutorial/step1.html" title="Step 1">Step 1</a></li>
       <li class="none"><a href="../tutorial/step2.html" title="Step 2">Step 2</a></li>
       <li class="none"><strong>Step 3</strong></li>
       <li class="none"><a href="../tutorial/step4.html" title="Step 4">Step 4</a></li>
       <li class="none"><a href="../tutorial/step5.html" title="Step 5">Step 5</a></li>
      </ul></li>
     <li class="none"><a href="../design.html" title="Design Considerations">Design Considerations</a></li>
     <li class="none"><a href="../todo.html" title="Todo's">Todo's</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="../project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
       <h5>Apache</h5>
    <ul>
     <li class="none"><a href="https://www.apache.org/" class="externalLink" title="Apache Website">Apache Website</a></li>
     <li class="none"><a href="https://www.apache.org/licenses/" class="externalLink" title="License">License</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works">How the ASF works</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a></li>
     <li class="none"><a href="https://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a></li>
     <li class="none"><a href="https://www.apache.org/security/" class="externalLink" title="Security">Security</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">


  

    <section>
<h2><a name="Implementing_an_Avalon_Service"></a>Implementing an Avalon Service</h2>

      <section>
<h3><a name="Defining_an_Interface_and_an_Implementation_Class"></a>Defining an Interface and an Implementation Class</h3>
        
<p>
          The evry first step is to define an interface and a corresponding implementation
          class.
          </p>
<ul>
            
<li>org.apache.fulcrum.yaafi.service.systemproperty.SystemPropertyService as interface</li>
            
<li>org.apache.fulcrum.yaafi.service.systemproperty.SystemPropertyServiceImpl as implementation class</li>
          </ul>
        
      </section>

      <section>
<h3><a name="Writing_the_interface"></a>Writing the interface</h3>
        
<p>
          The interface exposes only business methods and never ever one of the various Avalon
          interfaces.
          </p>
<div class="source">
<pre>
public interface SystemPropertyService
{
    // This interface doesn't exposes any other methods
}
          </pre></div>
        
      </section>

      <section>
<h3><a name="Chasing_the_Interfaces_to_Implement"></a>Chasing the Interfaces to Implement</h3>
        
<p>
          The Avalon Service Container interacts with an Avalon service
          through a bunch of interfaces also known as
          <a href="../lifecycle/index.html">Avalon Lifecycle
          Management Specification</a>. Finding the right interface might be
          challenge in the beginning but it is not an unsurmountable task.
          Our service needs access to the logging infrastructure, to the
          component configuration and needs to tell the Avalon Service
          Container that it is reconfigurable. To make things more
          interesting we want to dump the updated system properties into
          the temp directory of the application during service initialization.
          </p>
<div class="source">
<pre>
public class SystemPropertyServiceImpl
    extends AbstractLogEnabled
    implements SystemPropertyService, Reconfigurable, Contextualizable, Initializable
{
    // here comes the implementation ...
}
          </pre></div>
        
        
<p>
          Our service derives from &quot;AbstractLogEnabled&quot; which takes
          care of getting access to the logger. The implementation
          class also implements the &quot;Reconfigurable&quot; interface which
          tells the Avalon Service Container that the service implements
          </p>
<ul>
            
<li>public void configure(Configuration configuration)</li>
            
<li>public void reconfigure(Configuration configuration)</li>
          </ul>
        
        
<p>
          The information about the application context is provided by
          the &quot;Contextualizable&quot; interface while the service initialization
          needs the &quot;Initializable&quot; interface.
        </p>
      </section>

      <section>
<h3><a name="Accessing_the_Avalon_Context"></a>Accessing the Avalon Context</h3>
        
<p>
          The <a href="../specification/context.html">Avalon Context </a>contains
          environment settings such as the current working directory, the
          temporary directory or the name of the service.
            </p>
<div class="source">
<pre>
public void contextualize(Context context) throws ContextException
{
    this.tempDir = (File) context.get(&quot;urn:avalon:temp&quot;);
}
            </pre></div>
        
      </section>

      <section>
<h3><a name="Accessing_the_Component_Configuration"></a>Accessing the Component Configuration</h3>
        
<p>
          In the Role Configuration file we defined &quot;SystemPropertyService&quot; as shorthand for accessing
          the Component Configuration. The Component Configuration we use is shown below
            </p>
<div class="source">
<pre>
&lt;SystemPropertyService&gt;
    &lt;property name=&quot;FOO&quot;&gt;BAR&lt;/property&gt;
&lt;/SystemPropertyService&gt;
            </pre></div>
        
        
<p>
          Let's access the configuration to set the system properties - we get all childrem from
          the configuration instance and process them. Each child consists of an attribute
          containing the name and text for the value of the system property to be set. We also
          write some diagnostic ouptut by requesting the logger instance from &quot;AbstractLogEnabled&quot;.
            </p>
<div class="source">
<pre>
public void configure(Configuration configuration) throws ConfigurationException
{
    Configuration[] systemProperties = configuration.getChildren(&quot;property&quot;);

    for( int i=0; i&lt;systemProperties.length; i++ )
    {
        String key = systemProperties[i].getAttribute(&quot;name&quot;);
        String value = systemProperties[i].getValue();
        this.getLogger().debug( &quot;Setting the value of &quot; + key + &quot; to &quot; + value );
        System.setProperty( key, value );
    }
}
            </pre></div>
        
      </section>

      <section>
<h3><a name="Service_Initialization"></a>Service Initialization </h3>
        
<p>
          Since we have done most of our work already we use the
          service initialization to dump the current system properties
          into the temporary directory.
            </p>
<div class="source">
<pre>
public void initialize() throws Exception
{
    FileOutputStream fos = new FileOutputStream( new File(this.tempDir,&quot;system.properties&quot;) );
    System.getProperties().store( fos, &quot;system.properties&quot; );
    fos.flush();
    fos.close();
}
            </pre></div>
        
      </section>

      <section>
<h3><a name="Implementing_the_Reconfiguration"></a>Implementing the Reconfiguration</h3>
        
<p>
          Making our service reconfigurable is simple. When the service is
          reconfigured a new configuration instance is passed. We just reuse
          the configure() method to reinitalize our service - that's it.
          </p>
<div class="source">
<pre>
public void reconfigure(Configuration configuration) throws ConfigurationException
{
    this.configure(configuration);
}
          </pre></div>
        
      </section>

      <section>
<h3><a name="Putting_it_all_together"></a>Putting it all together</h3>
        
<p>
          Below you find your first complete and fully functional Avalon service.
          </p>
<div class="source">
<pre>
public interface SystemPropertyService
{
    // This interface doesn't exposes any other methods
}

public class SystemPropertyServiceImpl
    extends AbstractLogEnabled
    implements SystemPropertyService, Reconfigurable, Contextualizable, Initializable
{
    /** the Avalon temp directory */
    private File tempDir;

    /**
     * @see org.apache.avalon.framework.context.Contextualizable#contextualize(org.apache.avalon.framework.context.Context)
     */
    public void contextualize(Context context) throws ContextException
    {
        this.tempDir = (File) context.get(&quot;urn:avalon:temp&quot;);
    }

    /**
     * @see org.apache.avalon.framework.configuration.Configurable#configure(org.apache.avalon.framework.configuration.Configuration)
     */
    public void configure(Configuration configuration) throws ConfigurationException
    {
        Configuration[] systemProperties = configuration.getChildren(&quot;property&quot;);

        for( int i=0; i&lt;systemProperties.length; i++ )
        {
            String key = systemProperties[i].getAttribute(&quot;name&quot;);
            String value = systemProperties[i].getValue();
            this.getLogger().debug( &quot;Setting the value of &quot; + key + &quot; to &quot; + value );
            System.setProperty( key, value );
        }
    }

    /**
     * @see org.apache.avalon.framework.activity.Initializable#initialize()
     */
    public void initialize() throws Exception
    {
        FileOutputStream fos = new FileOutputStream( new File(this.tempDir,&quot;system.properties&quot;) );
        System.getProperties().store( fos, &quot;system.properties&quot; );
        fos.flush();
        fos.close();
    }

    /**
     * @see org.apache.avalon.framework.configuration.Reconfigurable#reconfigure(org.apache.avalon.framework.configuration.Configuration)
     */
    public void reconfigure(Configuration configuration)
        throws ConfigurationException
    {
        this.configure(configuration);
    }
}
          </pre></div>
        
      </section>

    </section>

  


      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2004&#x2013;2021<a href="https://www.apache.org/">The Apache Software Foundation</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
