<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurationUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fulcrum YAAFI</a> &gt; <a href="index.source.html" class="el_package">org.apache.fulcrum.yaafi.framework.util</a> &gt; <span class="el_source">ConfigurationUtil.java</span></div><h1>ConfigurationUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.apache.fulcrum.yaafi.framework.util;

import java.util.Map;

import org.apache.avalon.framework.configuration.Configuration;
import org.apache.avalon.framework.configuration.ConfigurationException;
import org.apache.avalon.framework.configuration.DefaultConfiguration;
import org.apache.avalon.framework.logger.Logger;

/**
 * Helper class to expand the value and all attributes.
 *
 * @author &lt;a href=&quot;mailto:siegfried.goeschl@it20one.at&quot;&gt;Siegfried Goeschl&lt;/a&gt;
 */
<span class="nc" id="L33">public class ConfigurationUtil</span>
{
    /**
     * Expand place holders found in values or attrbute values with the
     * content of the given variables. The implementation assumes that
     * the given configuration can be cast to a DefaultConfiguration
     * otherwise we can't use any setters.
     *
     * @param logger the logger to write diagnostic messages
     * @param defaultConfiguration the configuration
     * @param vars the map holding the variables
     * @throws ConfigurationException parsing the configuration failed
     */
    public static void expand(Logger logger, DefaultConfiguration defaultConfiguration, Map&lt;?, ?&gt; vars) throws ConfigurationException
    {
<span class="pc bpc" id="L48" title="2 of 4 branches missed.">        if( vars == null || vars.size() == 0)</span>
        {
<span class="nc" id="L50">            return;</span>
        }

        // update the value of the configuration element

<span class="fc bfc" id="L55" title="All 2 branches covered.">        if(defaultConfiguration.getValue(null) != null)</span>
        {
<span class="fc" id="L57">            String oldValue = defaultConfiguration.getValue();</span>
<span class="fc" id="L58">            String newValue = ConfigurationUtil.expand(oldValue, vars);</span>
<span class="fc" id="L59">            defaultConfiguration.setValue(newValue);</span>

<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if(oldValue.equals(newValue) == false)</span>
            {
<span class="nc" id="L63">                logger.debug(&quot;Changed element &lt;&quot;</span>
<span class="nc" id="L64">                    + defaultConfiguration.getName()</span>
                    + &quot;&gt; from '&quot;
                    + oldValue
                    + &quot;' ==&gt; '&quot;
                    + newValue
                    + &quot;'&quot;
                    );
            }
        }

        // update all attributes

<span class="fc" id="L76">        String attributeName = null;</span>
<span class="fc" id="L77">        String[] attributeNames = defaultConfiguration.getAttributeNames();</span>

<span class="fc bfc" id="L79" title="All 2 branches covered.">        for(int i=0; i&lt;attributeNames.length; i++)</span>
        {
<span class="fc" id="L81">            attributeName = attributeNames[i];</span>
<span class="fc" id="L82">            String oldAttributeValue = defaultConfiguration.getAttribute(attributeName);</span>
<span class="fc" id="L83">            String newAttributeValue = ConfigurationUtil.expand(oldAttributeValue, vars);</span>
<span class="fc" id="L84">            defaultConfiguration.setAttribute(attributeName, newAttributeValue);</span>

<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            if(oldAttributeValue.equals(newAttributeValue) == false)</span>
            {
<span class="nc" id="L88">                logger.debug(&quot;Changed attribute '&quot;</span>
<span class="nc" id="L89">                    + defaultConfiguration.getName() + &quot;@&quot; + attributeName</span>
                    + &quot;' from '&quot;
                    + oldAttributeValue
                    + &quot;' ==&gt; '&quot;
                    + newAttributeValue
                    + &quot;'&quot;
                    );
            }
        }

        // and now recurse through all children (children are in general a lot of work)

<span class="fc" id="L101">        Configuration[] children = defaultConfiguration.getChildren();</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">        for(int i=0; i&lt;children.length; i++)</span>
        {
<span class="fc" id="L105">            ConfigurationUtil.expand(logger, ((DefaultConfiguration) children[i]), vars);</span>
        }
<span class="fc" id="L107">    }</span>

    /**
     * Perform a series of substitutions. The substitutions
     * are performed by replacing ${variable} in the target
     * string with the value of provided by the key &quot;variable&quot;
     * in the provided hashtable.
     *
     * The unexpanded ${variable} is always written to 
     * the string buffer. 
     *
     * @param argStr target string
     * @param vars name/value pairs used for substitution
     * @return String target string with replacements.
     */
    private static String expand(String argStr, Map&lt;?, ?&gt; vars)
    {
    	// ignore failures
<span class="fc" id="L125">    	boolean isLenient = true;</span>
    	
<span class="fc" id="L127">    	StringBuilder argBuf = new StringBuilder();</span>
<span class="fc" id="L128">        int argStrLength = argStr.length();</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">        for (int cIdx = 0 ; cIdx &lt; argStrLength;)</span>
        {
<span class="fc" id="L132">            char ch = argStr.charAt(cIdx);</span>
<span class="fc" id="L133">            char del = ' ';</span>

<span class="pc bpc" id="L135" title="1 of 2 branches missed.">            switch (ch)</span>
            {
                case '$':
<span class="nc" id="L138">                    StringBuilder nameBuf = new StringBuilder();</span>
<span class="nc" id="L139">                    del = argStr.charAt(cIdx+1);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                    if( del == '{')</span>
                    {
<span class="nc" id="L142">                        cIdx++;</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">                        for (++cIdx ; cIdx &lt; argStr.length(); ++cIdx)</span>
                        {
<span class="nc" id="L146">                            ch = argStr.charAt(cIdx);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                            if (ch != '}')</span>
<span class="nc" id="L148">                                nameBuf.append(ch);</span>
                            else
                                break;
                        }

<span class="nc bnc" id="L153" title="All 2 branches missed.">                        if (nameBuf.length() &gt; 0)</span>
                        {
<span class="nc" id="L155">                            Object value = vars.get(nameBuf.toString());</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">                            if (value != null)</span>
                            {
<span class="nc" id="L159">                                argBuf.append(value.toString());</span>
                            }
                            else
                            {
<span class="nc bnc" id="L163" title="All 2 branches missed.">                                if (!isLenient)</span>
                                {
<span class="nc" id="L165">                                    throw new RuntimeException(&quot;No value found for : &quot; + nameBuf );</span>
                                }
                                else
                                {
<span class="nc" id="L169">                                    argBuf.append(&quot;${&quot;).append(nameBuf).append(&quot;}&quot;);</span>
                                }
                            }

<span class="nc" id="L173">                            del = argStr.charAt(cIdx);</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">                            if( del != '}')</span>
                            {
<span class="nc" id="L177">                                throw new RuntimeException(&quot;Delimineter not found for : &quot; + nameBuf );</span>
                            }
                        }

<span class="nc" id="L181">                        cIdx++;</span>
                    }
                    else
                    {
<span class="nc" id="L185">                        argBuf.append(ch);</span>
<span class="nc" id="L186">                        ++cIdx;</span>
                    }

<span class="nc" id="L189">                    break;</span>

                default:
<span class="fc" id="L192">                    argBuf.append(ch);</span>
<span class="fc" id="L193">                    ++cIdx;</span>
                    break;
            }
<span class="fc" id="L196">        }</span>

<span class="fc" id="L198">        return argBuf.toString();    	</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>